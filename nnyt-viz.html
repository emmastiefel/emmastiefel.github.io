<!DOCTYPE html>
<!-- 
     python -m http.server 8886 &.
-->
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>:D</title>
        <script src="https://d3js.org/d3.v5.min.js"></script>
        <script src="https://unpkg.com/enter-view"></script>
        <script src='https://cdnjs.cloudflare.com/ajax/libs/d3-legend/2.25.6/d3-legend.js'></script>

        <style>
            #slider {
                position: absolute;
                width: 7.5%;
                left: 2.5%;
                top: 60%;
            }
            #slider-input {
                appearance: none;
                height: 5px;
                width: 100%;
                background: black;
            }

            #slider-input::-webkit-slider-thumb {
                -webkit-appearance: none;
                appearance: none;
                width: 10px;
                height: 10px;
                background: black;
                }

            #slider-input::-moz-range-thumb {
                width: 10px;
                height: 10px;
                background: black;
                }
            
        </style>
    </head>

<body>

    
        
    <script type="text/javascript">
        var dataset;
        //LOAD DATA
        // now have reciprocity fees :)
        d3.csv("final-nnyt-data.csv").then(function(data){ //
            //store data as var:
            dataset = data;
            
            var h = 1000
            var w = 1000
            var p_h = 30
            var p_w = 30

            //create responsive svg
            var svg = d3.select("body").append("svg").attr("viewBox", '0 0 ' + w +' ' + h);

            //scale for dates
            var date_min= (d3.min(dataset, function(d){
                return d["date"];
            }));
            var date_max= (d3.max(dataset, function(d){
                return d["date"];
            }));
            var date_scale = d3.scaleLinear()
                                .domain([date_min, date_max])
                                .range([p_h, h - p_h]);

            //scale for likes/sizes
            var likes_min= (d3.min(dataset, function(d){
                return d["favorite_count"];
            }));
            var likes_max= (d3.max(dataset, function(d){
                return d["favorite_count"];
            }));
            var likes_scale = d3.scaleLinear()
                                .domain([likes_min, likes_max])
                                .range([5, 100]);


            //function to calculate percentage of value in the dataset
            function calculate_percentage(column, value) {
                return dataset.filter(function(d){ return d[column] == value}).length / dataset.length;
            }



            var nyt = svg.append('g');
                nyt.append('rect')
                    .attr("id", "nyt-box")
                    .attr("width", w*0.75)
                    .attr("height", h*0.75)
                    .attr("x", w*(0.25/2))
                    .attr("y", h/4)
                    .style("stroke", "black")
                    .style("fill", "none");
            //THE NEW YORK TIMES
                nyt.append('text')
                    .text("The New York Times")
                    .attr("id", "nyt-header")
                    .style("font-size", 50)
                    .attr("x", function(){
                        //center text :D
                        text_len = d3.select(this).node().getBBox()['width']
                        return (w/2) - (text_len/2)
                    })
                    .attr("y", function(){
                        //center text :D
                        text_h = d3.select(this).node().getBBox()['height']
                        return (h/4) + (text_h) + 10
                    });
            //NEW
                nyt.append('text')
                    .text("New")
                    .style("font-size", 50)
                    .style("fill", "white")
                    .style('stroke', 'black')
                    .style("font-family", "sans-serif")
                    .style("text-anchor", "middle")
                    .style("dominant-baseline", "central")
                    .attr("x", function(){
                        //center text :D
                        text_len = d3.select("#nyt-header").node().getBBox()['width']
                        return (w/2) - (text_len/2) + (text_len*0.2)
                    })
                    .attr("y", function(){
                        //center text :D
                        text_h = d3.select("#nyt-header").node().getBBox()['height']
                        return (h/4) + (text_h) - 10
                    })
                    .attr("transform", function() {
                        bb = d3.select(this).node().getBBox()
                        cx = bb["x"] + bb["width"]/2
                        cy = bb["y"] + bb["height"]/2
                        return "rotate(-20, " + cx + ", " + cy + ")"
                        });

                //DATE
                dates_unique = d3.set(dataset.map(d => d.date)).values()
                dates_unique = dates_unique.sort()
                nyt.append('text')
                    .text(dates_unique[0])
                    .attr("id", "nyt-date")
                    .style("font-size", 15)
                    .style("fill", "black")
                    .style("font-family", "serif")
                    .attr("x", function(){
                        //align on left side of paper
                        bb = d3.select("#nyt-box").node().getBBox()
                        return bb["x"] + 0.05*bb["width"]
                    })
                    .attr("y", function(){
                        //align to bottom of header text
                        bb = d3.select("#nyt-header").node().getBBox()
                        t_size = d3.select(this).node().getBBox()
                        return bb["y"] + bb["height"] - t_size["height"]
                    });

                //calculate nyt desk percentages
                unique_desks = d3.set(dataset.map(d => d.news_desk)).values()
                last_x = 0;
                desk_positions = []
                other = 0;
                for (i = 0; i < unique_desks.length; i ++) {
                    this_desk = unique_desks[i];
                    this_percentage = calculate_percentage("news_desk", this_desk);
                    if (this_percentage > 0.05 && this_desk != "") {
                        this_x = last_x + this_percentage
                        //console.log(this_desk, this_percentage);
                        desk_positions.push([last_x, this_x, this_desk, this_percentage])
                        last_x += this_percentage;
                    } else {
                        other += this_percentage
                    }
                }; 
                console.log(last_x)
                desk_positions.push([last_x, 1, 'Other'])

                //thte sort tis nnot working a;jd fao;fja o
                desk_positions = desk_positions.sort((a, b) => d3.ascending(a[3], b[3]))

                //draw columns for each desk
                nyt.selectAll('.desk')
                    .data(desk_positions)
                    .enter()
                    .append('g')
                    .attr("class", "desk");

                nyt.selectAll('.desk')
                    .append('text')
                    .attr('class', 'desk-name')
                    .text(function(d){ return d[2]})
                    .style("font-size", 10)
                    .attr("x", function(d){
                        bb = d3.select("#nyt-box").node().getBBox()
                        return bb["x"] + d[0]*bb["width"] + 2
                    })
                    .attr("y", function(){
                        bb = d3.select("#nyt-header").node().getBBox()
                        bb_this = d3.select(this).node().getBBox()
                        return bb["y"] + bb["height"] + + bb_this["height"] + 5
                    });
                
                nyt.selectAll('.desk')
                    .append('path')
                    .attr('d', function(d){
                        box_bb = d3.select("#nyt-box").node().getBBox()
                        var x = box_bb["x"] + d[0]*box_bb["width"]
                        header_bb = d3.select("#nyt-header").node().getBBox()
                        var y_1 = header_bb["y"] + header_bb["height"] + 5
                        var y_2 = box_bb["y"] + box_bb["height"]
                        return d3.line()([[x, y_1], [x, y_2]])
                    })
                    .style("stroke", "black");


            //words
            unique_sources = d3.set(dataset.map(d => d.combined_sources)).values()
            last_x = 0;
            source_positions = {}
            source_colors = {'none': 'Silver', //'rgb(176, 176, 176)',
                             'wiki': 'blue', //'rgb(144, 191, 222)',
                             'urbdict': 'red', //'rgb(189, 133, 222)',
                             'othlang': 'green'} // 'rgb(222, 203, 177)'}
            source_names = {'none': 'None', //'rgb(176, 176, 176)',
                             'wiki': 'Wikipedia', //'rgb(144, 191, 222)',
                             'urbdict': 'Urban Dictionary', //'rgb(189, 133, 222)',
                             'othlang': 'Other Languages',
                             "wiki othlang": 'Multiple'}
            for (i = 0; i < unique_sources.length; i ++) {
                this_source = unique_sources[i];
                this_percentage = calculate_percentage("combined_sources", this_source);
                this_x = last_x + this_percentage
                source_positions[this_source] = [last_x, this_x];
                last_x += this_percentage;

                //get interpolated colors (idk man roll with it)
                this_split = this_source.split(' ')
                if (this_split.length == 2) {
                    this_color = d3.interpolate(source_colors[this_split[0]], source_colors[this_split[1]])(0.5)
                    source_colors[this_source] = this_color;
                } else if (this_split.length == 3) {
                    int_col = d3.interpolate(source_colors[this_split[0]], source_colors[this_split[1]])(0.5)
                    this_color = d3.interpolate(int_col, source_colors[this_split[2]])(0.5)
                    source_colors[this_source] = this_color;
                }
                
            }; 

            //draw source labels
            svg.selectAll('.source-labels')
                .data(unique_sources)
                .enter()
                .append('text')
                .text(function(d){
                    console.log(d)
                    if (Object.keys(source_names).filter(n => n == d).length > 0) {
                        return source_names[d];
                    } else {
                        return ""
                    }
                })
                .attr("x", function(d){
                    this_range = source_positions[d]
                    return this_range[0] *(w-p_w*3)+p_w
                })
                .attr("y", function(d){  
                            return p_h/2;
                            })
                .style("fill", function(d){
                            return source_colors[d];
                        })
                .style('font-size', 10)
                .style('font-family', 'sans-serif');

            //draw all initial words :)
            svg.selectAll('.word')
                        .data(dataset)
                        .enter()
                        .append('text')
                        .attr("class", "word")
                        .attr("id", function(d){ return "D-" + d["date"];})
                        .attr("x", function(d){  
                            this_range = source_positions[d.combined_sources]
                            this_len = (this_range[1] - this_range[0])
                            word_len = d3.select(this).node().getBBox()
                            return  ((Math.random() * this_len) + this_range[0])*(w-p_w*3)+p_w
                            })
                        .attr("y", function(d){  
                            return Math.floor(Math.random()*(h/4 - p_h*2)) + p_h;
                            })
                        .text(function(d){return d["full_text"];})
                        .style("font-size", 5)
                        .style("fill", function(d){
                            return source_colors[d.combined_sources];
                        })
                        .style("fill-opacity", 0.7)
                        .style("font-family", "sans-serif");

            
            //transition ino desks
            function word_transition(date_filter) {
                //update date
                nyt.select("#nyt-date").text(date_filter);

                //move higlighted words tto the right position
                svg.selectAll('#' + "D-" + date_filter)
                .transition()
                .duration(4000)
                .attr("x", function(d){
                    //questionablee math to nicely space out random x positions
                    if (desk_positions.filter(function(dat){ return dat[2] == d.news_desk}).length > 0) {
                        this_desk_pos = (desk_positions.filter(function(dat){ return dat[2] == d.news_desk}))[0]
                    
                        } else {
                            this_desk_pos = (desk_positions.filter(function(dat){ return dat[2] == "Other"}))[0]
                            
                        };
                    bb = d3.select("#nyt-box").node().getBBox()
                    this_x = bb["x"] + this_desk_pos[0]*bb["width"] + 2
                    random_x = this_x + Math.floor(Math.random() * (this_desk_pos[1] - this_desk_pos[0]) * bb["width"])
                    word_bb = d3.select(this).node().getBBox()
                    if ((random_x + word_bb['width']) > (this_x + (this_desk_pos[1] - this_desk_pos[0]) * bb["width"] - 2)) {
                            return this_x
                        } else {
                            return random_x
                        }
                })
                .attr("y", function(){
                        bb = d3.select("#nyt-header").node().getBBox()
                        bb_box = d3.select("#nyt-box").node().getBBox()
                        this_min_y = bb["y"] + bb["height"] + 25
                        this_max_y = bb_box["height"] + bb_box["y"]
                        
                        return this_min_y + Math.floor(Math.random()*(this_max_y - this_min_y)) 
                    })

            }
            
        

            //animate based on time (?????????)

            //Date slider
            //<label for="points">Points (between 0 and 10):</label>
            d3.select('body').append('div').attr('id', 'slider');
            d3.select('#slider').append('label')
                             .attr('for', 'date-slider')
                             .text('Select a date to display:')
                             .style('display', 'block');
            d3.select('#slider').append('input')
                            .attr('name', 'date-slider')
                            .attr('id', 'slider-input')
                            .attr('type', 'range')
                            .attr('min', 0)
                            .attr('max', dates_unique.length)
                            .attr('value', 0)
                            .on("change", function(){

                                //reset all words?
                                svg.selectAll('.word')
                                .attr("x", function(d){  
                                    this_range = source_positions[d.combined_sources]
                                    this_len = (this_range[1] - this_range[0])
                                    return  ((Math.random() * this_len) + this_range[0])*(w-p_w*3)+p_w
                                    })
                                .attr("y", function(d){  
                                    return Math.floor(Math.random()*(h/4 - p_h*2)) + p_h;
                                    });

                                this_value = d3.select(this).property('value');
                                for (i=0; i <= this_value; i ++){
                                    this_date = dates_unique[i]
                                    this_date_data = dataset.filter(function(d){ return d.date == this_date})
                                    word_transition(this_date) }
                            });


        });</script>
</body>