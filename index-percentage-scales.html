<!DOCTYPE html>
<!-- 
     python -m http.server 8888 &.
-->
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>Test Student Visa Fee Viz</title>
        <script src="https://d3js.org/d3.v5.min.js"></script>
        <script src="https://unpkg.com/enter-view"></script>

        <style>
            h1, h2, h3, p, section {
                font-family: sans-serif;
            }
            .sections {
                position: absolute;
                display: inline-block;
                z-index: 100;
                width: 25%;
                top: 50%;
                left: 37.5%;
            }
            .step {
                text-align: center;
                background-color: rgba(255, 255, 255, 0.5);
                margin-bottom: 200%;
            }
            .plot-container{
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                overflow: scroll;
                display: inline-block;
                position: fixed;
                z-index: 1;
            }
            .hidden{
                display: none;
            }
        </style>
    </head>

<body>
    <div class="sections">
        <section class="step">
            ðŸ’¸ Understanding Student Visa Fees ðŸ’¸
        </section>
    </div>
    <div class="plot-container"></div>
    <script type="text/javascript">
        var dataset;
        //LOAD DATA
        d3.csv("student_visa_fees_emojis - student_visa_fees_emojis (1).csv", d3.autoType).then(function(data){
            //store data as var:
            dataset = data;
        
        //CALCULATE APPROXIMATE TOTALS
        for (i = 0; i < dataset.length; i++){
            console.log("hey")
        }

        //sort data by appr. total
        dataset.sort(function (a,b) {return d3.descending(a["Approximate_Total"], b["Approximate_Total"]);});
        
        //OVERALL SETUP
        var steps = ["USA","South Korea","India","Germany","Argentina","UK","Taiwan"]
        var step_colors = {"USA": "#EF4554", 
                              "South Korea": "#313F99", 
                              "India": "#0C9146", 
                              "Germany": "#F36F3B", 
                              "Argentina": "#FED41A", 
                              "UK": "#47BEE3", 
                              "Taiwan": "#89181E",
                              "Approximate_Total": "grey"}

        //SETUP SVG
        var w = 1000;
        var p = 2;
        var h = 450;
        //generate svg container
        var plot_svg = d3.select(".plot-container")
                         .append("svg")
                         .attr("viewBox", '0 0 ' + w +' ' + h); // make it responsive, hopefully

        //SCALES
        //max fee value is highest total fee
        var fee_max = (d3.max(dataset, function(d){
                return d["Approximate_Total"];
            }));
        //minimum fee value is lowest initial (usa) fee
        var fee_min= (d3.min(dataset, function(d){
                return d["USA"];
            }));
        //returns fee as percentage ww/ padding
        var fee_percent_scale = d3.scaleLinear()
                        .domain([fee_min, fee_max])
                        .range([p, 100-p]);  
        var bar_percent_scale = d3.scaleBand()
                                  .domain(dataset.map(d => d["Nationality"]))
                                  .range([5, 95]);
        
        //DRAW AXIS
        console.log(fee_min, fee_max)
        var fee_axis_scale = d3.scaleLinear()
                               .domain([fee_max, fee_min])
                               .range([p, h-p]);

        var formatAsCurrency = d3.format("$1,")
        var yAxis = d3.axisLeft()
                             .scale(fee_axis_scale)
                             .ticks(5)
                             .tickFormat(formatAsCurrency);
            plot_svg.append("g")
                    .attr("class", "y-axis")
                    //if you dont move it over it wont show up :)
                    .attr("transform", "translate(" + 40 + ", 0)")
                    .call(yAxis);

        //DRAW FLAGS

        //function to calculate cumulative fee/y-value
        function calculate_total(d, filter){
            //iterate through all steps but the last one (dont sum the total)
            current_sum = d[filter];
            for (i = 0; i < steps.length; i++){
                if (steps[i] != filter){
                    this_fee = d[steps[i]];
                    current_sum += this_fee;
                }
                else{
                    break;
                }
            };
            return current_sum; //return new total value as a percentage
        };
        
        //function to update data each time filter is called
        function update_flags(filter){
            //select + show bars for this filter
            plot_svg.selectAll("."+filter.replace(" ", "-"))
                .classed("hidden", false)

        };

        //INITIALIZE BARS
        //create div for each nationality
        plot_svg.selectAll(".fee-bar")
                    .data(dataset)
                    .enter()
                    .append("g")
                    .attr("id", function(d){
                        return d["Nationality"];
                    })
                    .attr("class", "fee-bar")
                        //create rect for each fee :D
                        .selectAll("rect")
                        .data(steps)
                        .enter()
                        .append("rect")
                        //class is hidden and fee country name
                        .attr("class", function(d){
                            return d.replace(" ", "-") + " hidden";
                        })
                        .attr("x", function(){
                            //calculate x using parent div nationality
                            parent_d = d3.select(this.parentNode).datum();
                            return bar_percent_scale(parent_d["Nationality"]) +"%";
                        })
                        .attr("width", bar_percent_scale.bandwidth()*2)
                        .attr("y", function(d){
                        parent_d = d3.select(this.parentNode).datum();
                        return 100 - fee_percent_scale(calculate_total(parent_d, d)) +"%";
                        })
                        .attr("height", function(d){
                            parent_d = d3.select(this.parentNode).datum();
                            return fee_percent_scale(parent_d[d])+"%";
                        })
                        .style("fill", function(d){
                            return step_colors[d];
                        });

        //SETUP STEP TEXT
        //add a step section for each available filter
        d3.select(".sections")
                .selectAll(".data-step")
                .data(steps)
                .enter()
                .append("section")
                .attr("class", "step data-step")
                .attr("id", function(d){return d;})
                .attr("number", function(d, i){return i;})
                .text(function(d){return d;});

        //SCROLL TRIGGERS - ENTER VIEW
        enterView({
            selector: '.data-step',
            enter: function(el) {
                el.classList.add('entered');
                this_filter = el.id; // store filter/element id
                update_flags(this_filter)
            },
            exit: function(el){
                console.log(el.number);
            },
            offset: 0.25, // enter at bottom of viewport
        });

            });//leave here 
            </script>
</body>