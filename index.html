<!DOCTYPE html>
<!-- 
     python -m http.server 8888 &.
-->
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>Test Student Visa Fee Viz</title>
        <script src="https://d3js.org/d3.v5.min.js"></script>
        <script src="https://unpkg.com/enter-view"></script>

        <style>
            h1, h2, h3, p, section {
                font-family: sans-serif;
            }
            .sections {
                position: absolute;
                display: inline-block;
                z-index: 100;
                width: 25%;
                top: 50%;
                left: 37.5%;
            }
            .step {
                text-align: center;
                background-color: rgba(255, 255, 255, 0.5);
                margin-bottom: 200%;
            }
            .plot-container{
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                overflow: scroll;
                display: inline-block;
                position: fixed;
                z-index: 1;
            }
            .flag{
                font-size: 100%;
            }
        </style>
    </head>

<body>
    <div class="sections">
        <section class="step">
            ðŸ’¸ Understanding Student Visa Fees ðŸ’¸
        </section>
    </div>
    <div class="plot-container"></div>
    <script type="text/javascript">
        var dataset;
        //LOAD DATA
        d3.csv("student_visa_fees_emojis - student_visa_fees_emojis (1).csv", d3.autoType).then(function(data){
            //store data as var:
            dataset = data;
        
        //OVERALL SETUP
        var steps = ["USA","South Korea","India","Germany","Argentina","UK","Taiwan"]
        var step_colors = {"USA": "#EF4554", 
                              "South Korea": "#313F99", 
                              "India": "#0C9146", 
                              "Germany": "#F36F3B", 
                              "Argentina": "#FED41A", 
                              "UK": "#47BEE3", 
                              "Taiwan": "#89181E",
                              "Approximate_Total": "grey"}

        //SETUP SVG
        var w = 100;
        h = 100;
        var p = 5;
        //generate svg container
        var plot_svg = d3.select(".plot-container")
                         .append("svg")
                         .attr("width", "100%")
                         .attr("height", "100%");

        //SCALES
        //x-axis = approximate total
        var y_max = (d3.max(dataset, function(d){
                return d["Approximate_Total"];
            }));
        //minimum x-value is lowest initial (usa) fee
        var y_min= (d3.min(dataset, function(d){
                return d["USA"];
            }));
        var yScale = d3.scaleLinear()
                        .domain([y_min, y_max])
                        .range([h-p, p]);  
        

        //DRAW FLAGS

        //function to calculate cumulative fee/y-value
        function calculate_y(d, filter){
            //iterate through all steps but the last one (dont sum the total)
            current_sum = d[filter];
            for (i = 0; i < steps.length; i++){
                if (steps[i] != filter){
                    this_fee = d[steps[i]];
                    current_sum += this_fee;
                }
                else{
                    break;
                }
            };
            return yScale(current_sum) + "%"; //return new x value as a percentage
        };
        
        //function to space out flags along x-axis:
        function space_flags(d, i, filter){
            //default x-axis value
            this_x = 0;
            c = 1;
            //find y-value for current datapoint
            this_y = calculate_y(d, filter);//yScale(dataset[i][filter]);
            //iterate through all datapoints until you reach the first one
            while ((i-c) > 0) {
                //find the y-value for the given previous point
                prev_y = calculate_y(dataset[i-c],filter);
                //if the previous point overlaps with this one, increment its x-position by p
                if (this_y == prev_y){
                    this_x = this_x + 1;
                };
                c = c + 1;//increment c by 1 each iteration
            };
            if (this_x > x_max) {
                x_max = this_x;
            }
            return this_x + "%"; //return new x value as a percentage
        };

        //function to update data each time filter is called
        function update_flags(filter){
            //update background color to match current filter
            d3.select(".plot-container").style("background-color", step_colors[filter])

            //add flags to svg
            x_max = 100; //var to track max x-value :)
            raw_amount = 0;
            plot_svg.selectAll(".flag")
                    .transition()
                    .attr("y", function(d){
                        return calculate_y(d, filter);
                    })
                    .attr("x", function(d, i){
                        return space_flags(d, i, filter);
                    });
            //resize to match width
            plot_svg.attr("width", x_max + "%");
        };

        //INITIALIZE FLAGS
        plot_svg.selectAll("text")
                    .data(dataset)
                    .enter()
                    .append("text")
                    .attr("class", "flag")
                    .attr("y", function(){
                        return yScale(Math.random() * (y_max-y_min)) + "%";
                    })
                    .attr("x", function(){
                        return yScale(Math.random() * (y_max-y_min)) + "%";
                    })
                    .text(function(d){   return d.Emojis; });

        //SETUP STEP TEXT
        //add a step section for each available filter
        d3.select(".sections")
                .selectAll(".data-step")
                .data(steps)
                .enter()
                .append("section")
                .attr("class", "step data-step")
                .attr("id", function(d){return d;})
                .text(function(d){return d;});

        //SCROLL TRIGGERS - ENTER VIEW
        enterView({
            selector: '.data-step',
            enter: function(el) {
                el.classList.add('entered');
                this_filter = el.id; // store filter/element id
                console.log(el.id)
                update_flags(this_filter)
            },
            exit: function(el){
                el.classList.remove('entered');
            },
            offset: 0.25, // enter at bottom of viewport
        });

            });//leave here 
            </script>
</body>