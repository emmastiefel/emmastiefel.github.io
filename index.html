<!DOCTYPE html>
<!-- 
     python -m http.server 8888 &.
-->
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>Test Student Visa Fee Viz</title>
        <script src="https://d3js.org/d3.v5.min.js"></script>
        <script src="https://unpkg.com/enter-view"></script>
        <script src="d3-tip.js"></script>

        <style>
            h1, h2, h3, p, section {
                font-family: sans-serif;
            }
            .sections {
                position: absolute;
                display: inline-block;
                z-index: 100;
                width: 25%;
                top: 50%;
                left: 75%;
                pointer-events:none;
                margin: 10px;
            }
            .sections p {
                text-align: left;
                font-weight: normal;
                left: 10%
                width: 90%;
            }
            .step {
                text-align: center;
                font-weight: bold;
                background-color: rgba(255, 255, 255, 1);
                margin-bottom: 200%;
            }
            .d3-tip {
                line-height: 1;
                padding: 6px;
                background: rgba(0, 0, 0, 0.8);
                color: #fff;
                border-radius: 4px;
                font-size: 12px;
                z-index: 90;
            }
            .tooltip{
                position: absolute;
            }
            .plot-container{
                top: 0;
                left: 0;
                width: 75%;
                height: 100%;
                overflow: scroll;
                display: inline-block;
                position: fixed;
                z-index: 1;
                padding: 1%;
                overflow: hidden;
            }
            .hidden{
                display: none;
            }
        </style>
    </head>

<body>
    <div class="sections">
        <section class="step">
            ðŸ’¸ Understanding Student Visa Fees ðŸ’¸
            <p>All Minerva students have to pay student visa fees in order to complete the global rotation. But many students are not fully aware of these fees when they enroll, and more misestimate fees even if they anticipate them. 
                Of 12 students who responded to a Quest anonymous survey, five students said they either did not expect to pay for student visa fees or did not have any estimated amount in mind when they enrolled. 
                Eight of the respondents reported paying more for student visa fees than they anticipated. 
            </p>
            <p>How much students pay in student visa fees varies significantly between nationalities. 
                Some rotation countries raise fees for specific nationalities, increasing costs.
            </p>
            

        </section>
        
    </div>
    
    <div class="plot-container">
    </div>
    <script type="text/javascript">
        var dataset;
        //LOAD DATA
        // now have reciprocity fees :)
        d3.csv("corrected - minerva_students_visa_fees - minerva_students_visa_fees.csv", d3.autoType).then(function(data){
            //store data as var:
            dataset = data;

        //sort data by appr. total
        dataset.sort(function (a,b) {return d3.descending(a["Approximate_Total"], b["Approximate_Total"]);});
        
        //OVERALL SETUP
        var steps = ["USA", "USA Reciprocity Fee", "South Korea","India","Germany","Argentina","UK","Taiwan", "USA Reapply", "USA Reapply Reciprocity"]
        var step_colors = {"USA": "#EF4554", 
                              "USA Reciprocity Fee": "#EF4554",
                              "South Korea": "#313F99", 
                              "India": "#0C9146", 
                              "Germany": "#F36F3B", 
                              "Argentina": "#FED41A", 
                              "UK": "#47BEE3", 
                              "Taiwan": "#89181E",
                              "USA Reapply": "#EF4554",
                              "USA Reapply Reciprocity": "#EF4554"}

        //SETUP SVG
        var w = 1000;
        var p_h = 10;
        var p_w = 45;
        var h = 450;
        //generate svg container
        var plot_svg = d3.select(".plot-container")
                         .append("svg")
                         .attr("viewBox", '0 0 ' + w +' ' + h+p_h); // make it responsive, hopefully

        //CREATE TOOLTIP
        // Setup the tool tip.  Note that this is just one example, and that many styling options are available.
        // See original documentation for more details on styling: http://labratrevenge.com/d3-tip/
        var tool_tip = d3.tip()
            .attr("class", "d3-tip")
            .offset([0, 0])
            .html(function(d){return d;});
        plot_svg.call(tool_tip);

        //SCALES
        //max fee value is highest total fee
        var fee_max = (d3.max(dataset, function(d){
                return d["Approximate_Total"];
            }));
        //minimum fee value is lowest initial (usa) fee
        var fee_min= (d3.min(dataset, function(d){
                return d["USA"];
            }));
        //returns fee as percentage ww/ padding
        var fee_percent_scale = d3.scaleLinear()
                        .domain([fee_min, fee_max])
                        .range([0, h-p_h]);  
        var bar_percent_scale = d3.scaleBand()
                                  .domain(dataset.map(d => d["Emojis"]))
                                  .range([p_w, w-p_w/4]);
        
        //DRAW AXIS
        console.log(fee_min, fee_max)
        var fee_axis_scale = d3.scaleLinear()
                               .domain([fee_max, fee_min])
                               .range([0, h-p_h]);

        var formatAsCurrency = d3.format("$1,")
        var yAxis = d3.axisLeft()
                             .scale(fee_axis_scale)
                             .ticks(5)
                             .tickFormat(formatAsCurrency);
            plot_svg.append("g")
                    .attr("class", "y-axis")
                    //if you dont move it over it wont show up :)
                    .attr("transform", "translate(" + 40 + ", 0)")
                    .call(yAxis);
        //X-AXIS/COUNTRY FLAG EMOJIS
        var xAxis = d3.axisBottom()
                      .tickSize(0)
                      .scale(bar_percent_scale);
            plot_svg.append("g")
                    .attr("class", "x-axis")
                    .attr("transform", "translate( 0, " + (h - p_h)+ ")")
                    .call(xAxis);   

        //DRAW BARS
        //function to calculate cumulative fee/y-value
        function calculate_total(d, filter){
            //set initial value to fee for this step
            current_sum = d[filter];
            
            //iterate through all steps
            for (i = 0; i < steps.length + 1; i++){
                if (steps[i] != filter){
                    this_fee = d[steps[i]];
                    current_sum += this_fee;
                }
                else{
                    break;
                }
            };
            
            return current_sum; //return new total value as a percentage
        };
        
        //function to update data each time filter is called
        function update_flags(filter){
            //select + show bars for this filter
            plot_svg.selectAll("."+filter.replaceAll(" ", "-"))
                .classed("hidden", false)
            plot_svg.selectAll(".fee-bar")
                    .attr("filter", filter);

        };

        //INITIALIZE BARS
        //create div for each nationality
        plot_svg.selectAll(".fee-bar")
                    .data(dataset)
                    .enter()
                    .append("g")
                    .attr("id", function(d){
                        return d["Nationality"];
                    })
                    .attr("class", "fee-bar")
                        //create rect for each fee :D
                        .selectAll("rect")
                        .data(steps)
                        .enter()
                        .append("rect")
                        //class is hidden and fee country name
                        .attr("class", function(d){
                            return d.replaceAll(" ", "-") + " hidden";
                        })
                        .attr("x", function(){
                            //calculate x using parent div nationality
                            parent_d = d3.select(this.parentNode).datum();
                            return bar_percent_scale(parent_d["Emojis"]);
                        })
                        //set width using bar scale
                        .attr("width", bar_percent_scale.bandwidth())
                        .attr("y", function(d){
                            parent_d = d3.select(this.parentNode).datum();
                            return h - fee_percent_scale(calculate_total(parent_d, d))- p_h;// ;
                        })
                        .attr("height", function(d){
                            parent_d = d3.select(this.parentNode).datum();
                            return fee_percent_scale(parent_d[d]);
                        })
                        .style("fill", function(d){
                            return step_colors[d];
                        })
                        .on("mouseover", tool_tip.show)
                        .on("mouseout", tool_tip.hide);

        //HOVER TOOLTIPS - SHOW COUNTRY NAME + NOTES
        plot_svg.selectAll(".fee-bar")
            .on("mouseover", function(d){
                //make bars transparent to highlight
                d3.select(this).selectAll("rect")
                    .style("opacity", 0.6);

            })
            .on("mouseout", function(d){
                //return to full opacity
                d3.select(this).selectAll("rect")
                    .style("opacity", 1);

            })

        //SETUP STEP TEXT
        //add a step section for each available filter
        d3.select(".sections")
                .selectAll(".data-step")
                .data(steps)
                .enter()
                .append("section")
                .attr("class", "step data-step")
                .attr("id", function(d){return d;})
                .text(function(d){return d;})
                .style("color", function(d){return step_colors[d];});     

        //SCROLL TRIGGERS - ENTER VIEW
        enterView({
            selector: '.data-step',
            enter: function(el) {
                el.classList.add('entered');
                this_filter = el.id; // store filter/element id
                update_flags(this_filter)
            },
            exit: function(el){
                //console.log(el.id);
            },
            offset: 0.25, // enter at bottom of viewport
        });

            });//leave here 
            </script>
</body>